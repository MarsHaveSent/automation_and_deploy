import os
from pathlib import Path
from datetime import datetime
from dotenv import load_dotenv

# Загружаем переменные окружения
load_dotenv()

BASE_DIR = Path(__file__).parent
DATA_DIR = BASE_DIR / "data"
SQL_DIR = BASE_DIR / "sql"
SCRIPTS_DIR = BASE_DIR / "scripts"

# Создаем папки если их нет
for directory in [DATA_DIR, SQL_DIR, SCRIPTS_DIR]:
    directory.mkdir(exist_ok=True, parents=True)

# Настройки генератора (можно переопределить через .env)
NUM_STORES = int(os.getenv('NUM_STORES', 10))
MIN_CASH_REGISTERS_PER_STORE = 1
MAX_CASH_REGISTERS_PER_STORE = 4
RECEIPTS_PER_CASH_PER_DAY = 50
ITEMS_PER_RECEIPT_MIN = 1
ITEMS_PER_RECEIPT_MAX = 10

# Настройки БД из .env
DB_CONFIG = {
    'host': os.getenv('POSTGRES_HOST', 'localhost'),
    'port': int(os.getenv('POSTGRES_PORT', 5432)),
    'database': os.getenv('POSTGRES_DB', 'sales_db'),
    'user': os.getenv('POSTGRES_USER', 'postgres'),
    'password': os.getenv('POSTGRES_PASSWORD', 'password')
}

# Настройки загрузки
BATCH_SIZE = int(os.getenv('BATCH_SIZE', 1000))
MAX_RETRIES = int(os.getenv('MAX_RETRIES', 3))

# Категории товаров
CATEGORIES = [
    "бытовая химия",
    "текстиль",
    "посуда",
    "кухонная утварь",
    "хозтовары",
    "освещение",
    "инструменты",
    "сантехника",
    "электротовары",
    "мебель"
]

# Примеры товаров по категориям с ценами в рублях
PRODUCTS_BY_CATEGORY = {
    "бытовая химия": [
        {"item": "Стиральный порошок Автомат 3кг", "price_range": (300, 800)},
        {"item": "Кондиционер для белья 1л", "price_range": (150, 400)},
        {"item": "Жидкое мыло для рук 500мл", "price_range": (80, 250)},
        {"item": "Средство для мытья посуды 450мл", "price_range": (70, 200)},
        {"item": "Чистящее средство для кухни 500мл", "price_range": (120, 350)},
        {"item": "Освежитель воздуха 300мл", "price_range": (90, 280)},
        {"item": "Средство для чистки унитаза 750мл", "price_range": (130, 320)},
        {"item": "Пятновыводитель 500мл", "price_range": (110, 300)},
        {"item": "Средство для мытья полов 1л", "price_range": (140, 380)},
        {"item": "Антистатик для одежды 400мл", "price_range": (95, 260)},
        {"item": "Средство для чистки стекол 500мл", "price_range": (115, 310)},
        {"item": "Гель для стирки цветного белья 1л", "price_range": (180, 420)},
        {"item": "Таблетки для посудомоечной машины 30шт", "price_range": (250, 600)},
        {"item": "Средство для удаления накипи 500мл", "price_range": (160, 370)},
        {"item": "Чистящий крем для ванной 400мл", "price_range": (125, 290)}
    ],
    
    "текстиль": [
        {"item": "Полотенце банное 100х150см", "price_range": (400, 1200)},
        {"item": "Постельное белье 1.5-спальное", "price_range": (1500, 4500)},
        {"item": "Коврик для ванной 60х90см", "price_range": (300, 900)},
        {"item": "Шторы тюль 3м", "price_range": (800, 2500)},
        {"item": "Плед флисовый 140х200см", "price_range": (700, 1800)},
        {"item": "Скатерть 150х150см", "price_range": (350, 1100)},
        {"item": "Наволочка 50х70см", "price_range": (150, 450)},
        {"item": "Простынь на резинке 160х200см", "price_range": (600, 1500)},
        {"item": "Полотенце кухонное 50х70см", "price_range": (80, 300)},
        {"item": "Чехол на подушку 70х70см", "price_range": (200, 600)},
        {"item": "Покрывало на диван", "price_range": (1200, 3500)},
        {"item": "Коврик придверный 60х40см", "price_range": (250, 750)},
        {"item": "Салфетки столовые набор 6шт", "price_range": (120, 400)},
        {"item": "Термоодеяло 140х205см", "price_range": (2000, 5000)},
        {"item": "Римские шторы 120х150см", "price_range": (900, 2800)}
    ],
    
    "посуда": [
        {"item": "Набор кастрюль 3 предмета", "price_range": (2000, 6000)},
        {"item": "Сковорода с антипригарным покрытием 24см", "price_range": (800, 2500)},
        {"item": "Кружка керамическая 350мл", "price_range": (150, 500)},
        {"item": "Тарелка обеденная 23см", "price_range": (200, 700)},
        {"item": "Набор столовых приборов 24 предмета", "price_range": (1200, 3500)},
        {"item": "Стеклянный бокал для вина 450мл", "price_range": (250, 850)},
        {"item": "Чайник заварочный 1л", "price_range": (400, 1300)},
        {"item": "Салатница стеклянная 1.5л", "price_range": (300, 900)},
        {"item": "Формы для выпечки набор 3шт", "price_range": (500, 1600)},
        {"item": "Соусник керамический 300мл", "price_range": (180, 550)},
        {"item": "Кофейный сервиз 6 персон", "price_range": (1500, 4500)},
        {"item": "Стеклянный графин 1л", "price_range": (350, 1100)},
        {"item": "Дуршлаг пластиковый 24см", "price_range": (150, 450)},
        {"item": "Лопатка кухонная силиконовая", "price_range": (100, 350)},
        {"item": "Термос 1л", "price_range": (600, 1800)}
    ],
    
    "кухонная утварь": [
        {"item": "Разделочная доска пластиковая", "price_range": (150, 500)},
        {"item": "Нож шеф-повара 20см", "price_range": (600, 2000)},
        {"item": "Терка 4-х сторонняя", "price_range": (250, 800)},
        {"item": "Соковыжималка для цитрусовых", "price_range": (400, 1200)},
        {"item": "Кухонные весы электронные 5кг", "price_range": (300, 1000)},
        {"item": "Таймер кухонный механический", "price_range": (100, 350)},
        {"item": "Измельчитель ручной", "price_range": (200, 650)},
        {"item": "Скалка деревянная 40см", "price_range": (120, 400)},
        {"item": "Набор мерных ложек 5шт", "price_range": (80, 300)},
        {"item": "Венчик для взбивания", "price_range": (90, 320)},
        {"item": "Молоток для мяса", "price_range": (150, 480)},
        {"item": "Консервный нож ручной", "price_range": (110, 370)},
        {"item": "Штопор с рычагом", "price_range": (130, 420)},
        {"item": "Термометр кухонный", "price_range": (180, 550)},
        {"item": "Пресс для чеснока", "price_range": (95, 310)}
    ],
    
    "хозтовары": [
        {"item": "Ведро пластиковое 10л", "price_range": (150, 450)},
        {"item": "Швабра с отжимом", "price_range": (300, 900)},
        {"item": "Набор щеток для уборки 5шт", "price_range": (200, 600)},
        {"item": "Перчатки резиновые хозяйственные", "price_range": (50, 200)},
        {"item": "Мешки для мусора 30л 30шт", "price_range": (100, 350)},
        {"item": "Коврик протирочный", "price_range": (80, 280)},
        {"item": "Стеллаж металлический 5 полок", "price_range": (1200, 3500)},
        {"item": "Ящик пластиковый для хранения 60л", "price_range": (400, 1200)},
        {"item": "Лестница-стремянка 3 ступени", "price_range": (800, 2200)},
        {"item": "Термосумка 20л", "price_range": (350, 1000)},
        {"item": "Сушилка для белья напольная", "price_range": (600, 1800)},
        {"item": "Тачка садовая 80л", "price_range": (1500, 4000)},
        {"item": "Грабли садовые", "price_range": (250, 750)},
        {"item": "Лейка пластиковая 5л", "price_range": (120, 400)},
        {"item": "Совок и щетка для мусора", "price_range": (90, 300)}
    ],
    
    "освещение": [
        {"item": "Лампа светодиодная E27 10Вт", "price_range": (100, 350)},
        {"item": "Люстра 5-рожковая", "price_range": (2500, 7000)},
        {"item": "Торшер напольный", "price_range": (1200, 3500)},
        {"item": "Настольная лампа с LED", "price_range": (600, 1800)},
        {"item": "Светильник настенный бра", "price_range": (800, 2500)},
        {"item": "Гирлянда LED 5м 100 ламп", "price_range": (300, 900)},
        {"item": "Прожектор уличный 50Вт", "price_range": (700, 2000)},
        {"item": "Лампа накаливания 60Вт", "price_range": (50, 150)},
        {"item": "Светодиодная лента 5м", "price_range": (400, 1200)},
        {"item": "Ночник с датчиком движения", "price_range": (250, 750)},
        {"item": "Люминесцентная лампа 18Вт", "price_range": (150, 450)},
        {"item": "Светильник потолочный точечный", "price_range": (200, 650)},
        {"item": "Лампа для растений фитолампа", "price_range": (500, 1500)},
        {"item": "Фонарь уличный солнечный", "price_range": (350, 1100)},
        {"item": "Аварийный светильник", "price_range": (450, 1300)}
    ],
    
    "инструменты": [
        {"item": "Набор отверток 6 предметов", "price_range": (300, 900)},
        {"item": "Молоток слесарный 500г", "price_range": (250, 750)},
        {"item": "Плоскогубцы комбинированные 200мм", "price_range": (350, 1000)},
        {"item": "Набор ключей рожковых 8-19мм", "price_range": (400, 1200)},
        {"item": "Рулетка измерительная 5м", "price_range": (150, 450)},
        {"item": "Ножовка по металлу", "price_range": (200, 600)},
        {"item": "Уровень пузырьковый 60см", "price_range": (250, 800)},
        {"item": "Дрель электрическая 600Вт", "price_range": (1500, 4000)},
        {"item": "Набор бит для шуруповерта 25шт", "price_range": (180, 550)},
        {"item": "Ключ разводной 250мм", "price_range": (300, 850)},
        {"item": "Кусачки боковые 180мм", "price_range": (220, 700)},
        {"item": "Степлер строительный", "price_range": (400, 1100)},
        {"item": "Стамеска набор 4шт", "price_range": (280, 800)},
        {"item": "Термоклеевой пистолет 40Вт", "price_range": (350, 950)},
        {"item": "Напильник плоский 200мм", "price_range": (120, 400)}
    ],
    
    "сантехника": [
        {"item": "Смеситель для раковины", "price_range": (1200, 3500)},
        {"item": "Душевая лейка с гибким шлангом", "price_range": (800, 2200)},
        {"item": "Унитаз компакт", "price_range": (3000, 8000)},
        {"item": "Раковина накладная 50см", "price_range": (1500, 4500)},
        {"item": "Сифон для раковины", "price_range": (300, 900)},
        {"item": "Полотенцесушитель электрический", "price_range": (2000, 5500)},
        {"item": "Душевая кабина угловая", "price_range": (8000, 25000)},
        {"item": "Кран шаровой 1/2", "price_range": (150, 500)},
        {"item": "Гибкая подводка для воды 50см", "price_range": (100, 350)},
        {"item": "Водоочистительный фильтр", "price_range": (1200, 3200)},
        {"item": "Счетчик воды холодной", "price_range": (600, 1800)},
        {"item": "Полипропиленовая труба 20мм 2м", "price_range": (80, 250)},
        {"item": "Фум лента 12ммх12м", "price_range": (30, 120)},
        {"item": "Умывальник с тумбой", "price_range": (5000, 15000)},
        {"item": "Ванна акриловая 170см", "price_range": (10000, 30000)}
    ],
    
    "электротовары": [
        {"item": "Удлинитель 5м 3 розетки", "price_range": (300, 900)},
        {"item": "Розетка с заземлением", "price_range": (150, 450)},
        {"item": "Выключатель одноклавишный", "price_range": (120, 380)},
        {"item": "Автоматический выключатель 16А", "price_range": (200, 600)},
        {"item": "Терморегулятор для теплого пола", "price_range": (1200, 3200)},
        {"item": "Таймер розеточный", "price_range": (400, 1100)},
        {"item": "Стабилизатор напряжения 1000Вт", "price_range": (1500, 4000)},
        {"item": "Сетевой фильтр 6 розеток", "price_range": (350, 950)},
        {"item": "Трехфазная розетка 32А", "price_range": (600, 1800)},
        {"item": "Кабель электрический 3х2.5 100м", "price_range": (2500, 6000)},
        {"item": "Распределительная коробка 100х100", "price_range": (80, 250)},
        {"item": "Изолента ПВХ 19мм", "price_range": (30, 100)},
        {"item": "Ламповый патрон E27", "price_range": (40, 150)},
        {"item": "Датчик движения для освещения", "price_range": (350, 900)},
        {"item": "Блок розеток 4 места", "price_range": (450, 1200)}
    ],
    
    "мебель": [
        {"item": "Стул кухонный", "price_range": (800, 2500)},
        {"item": "Стол обеденный 120х80см", "price_range": (2500, 7000)},
        {"item": "Тумба под раковину 60см", "price_range": (2000, 5500)},
        {"item": "Вешалка прихожая напольная", "price_range": (1200, 3500)},
        {"item": "Полка настенная 80см", "price_range": (600, 1800)},
        {"item": "Комод 4-х ящичный", "price_range": (3000, 8000)},
        {"item": "Кровать односпальная", "price_range": (4000, 12000)},
        {"item": "Матрас ортопедический 90х200", "price_range": (5000, 15000)},
        {"item": "Шкаф купе 2-х дверный", "price_range": (8000, 25000)},
        {"item": "Пуфик для ног", "price_range": (700, 2000)},
        {"item": "Журнальный столик 60х60", "price_range": (1500, 4500)},
        {"item": "Стеллаж книжный 5 полок", "price_range": (2000, 6000)},
        {"item": "Тумба под ТВ 120см", "price_range": (2500, 7000)},
        {"item": "Зеркало в раме 60х90", "price_range": (800, 2500)},
        {"item": "Кресло компьютерное", "price_range": (3000, 9000)}
    ]
}


# Настройки генерации данных
GENERATION_SETTINGS = {
    'start_date': '2024-01-01',  # Дата начала генерации (для тестов)
    'end_date': datetime.now().strftime('%Y-%m-%d'),
    'weekend_skip': True,  # Пропускать выходные
    'holidays': []  # Список праздничных дней
}

# Процент скидки
DISCOUNT_PROBABILITY = 0.3  # 30% товаров со скидкой
DISCOUNT_RANGE = (0.05, 0.3)  # Скидка от 5% до 30%

# Проверяем что все категории имеют товары
def validate_config():
    """Валидация конфигурации"""
    for category in CATEGORIES:
        if category not in PRODUCTS_BY_CATEGORY:
            raise ValueError(f"Категория '{category}' не имеет товаров в PRODUCTS_BY_CATEGORY")
        
        if len(PRODUCTS_BY_CATEGORY[category]) == 0:
            raise ValueError(f"Категория '{category}' имеет пустой список товаров")
    
    print("Конфигурация успешно проверена")
    print(f"Всего категорий: {len(CATEGORIES)}")
    print(f"Всего товаров: {sum(len(products) for products in PRODUCTS_BY_CATEGORY.values())}")

# Проверяем обязательные переменные
def check_required_env_vars():
    """Проверка обязательных переменных окружения"""
    required_vars = ['POSTGRES_HOST', 'POSTGRES_DB', 'POSTGRES_USER']
    missing_vars = []
    
    for var in required_vars:
        if not os.getenv(var):
            missing_vars.append(var)
    
    if missing_vars:
        raise EnvironmentError(
            f"Отсутствуют обязательные переменные окружения: {', '.join(missing_vars)}\n"
            f"Скопируйте .env.example в .env и заполните значения"
        )

if __name__ == "__main__":
    # Запуск проверки на переменные окружения при прямом вызове файла 
    check_required_env_vars()
    # Запуск валидации при прямом вызове файла
    validate_config()